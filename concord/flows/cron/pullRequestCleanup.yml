triggers:
  - cron:
      spec: "*/5 * * * *"
      entryPoint: githubPRCleanup

flows:
  githubPRCleanup:
    - log: "Cleaning up existing pull requests created based on IMA testing"
    - set:
        githubToken: "${crypto.exportAsString('Hawkeye', 'github_token', null)}"
        githubProducts: [
          {productName: "test-product"},
          {productName: "opc_ua_test"},
          {productName: "opc-ua-poc"}]
        imaUserName: "amguist"
    - call: perform-cleanup
      withItems: ${githubProducts}

  perform-cleanup:
    - set:
        projectName: ${item.productName}
    - log: "Cleaning up repository: ${projectName}"
    - expr: ${"https://github.com/".concat(organization).concat("/").concat(item.productName).concat(".git")}
      out: apiUrl
    - task: github
      in:
        action: getPRList
        accessToken: ${githubToken}
        org: ${organization}
        repo: ${item.productName}
        base: "main"
        state: "open"
    - if: ${prList.isEmpty()}
      then:
        - log: "No Open PRs to pull details for ..."
      else:
        - expr: ${prList.stream().filter(i -> i.user.login.equals(imaUserName) && i.head.ref.contains("-IMA")).map(c -> {'number':c.number,'branch':c.head.ref,'created_at':c.created_at}).toList()}
          out: retrievedPullRequests
        - call: clean
          withItems: ${retrievedPullRequests}

  clean:
    - log: "Item values are as follows: ${item}"
    - script: groovy
      body: |
        import groovy.time.*

        def start = "${item.created_at}"
        def now = new Date()
        def format = "yyyy-MM-dd'T'HH:mm:ss.SSSZ"
        
        start = Date.parse(format , start.replaceAll(/([+\-])(\d\d):(\d\d)/, /$1$2$3/))
        println start
        now = Date.parse(format , now.replaceAll(/([+\-])(\d\d):(\d\d)/, /$1$2$3/))
        println now
        
        TimeDuration duration = TimeCategory.minus(stop, start)
        println duration