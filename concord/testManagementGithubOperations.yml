flows:
  performGithubOperations:
    - expr: ${"https://github.com/".concat(organization).concat("/").concat(projectName).concat(".git")}
      out: apiUrl
    - task: github
      in:
        action: ${actionName}
        accessToken: ${githubToken}
        org: ${organization}
        repo: ${projectName}
    - if: ${branchList.contains(entityId)}
      then:
        - checkpoint: "Update_${branch}_${projectName}"
        - call: gitCloneBranch
          in:
            url: ${apiUrl}
      else:
        - checkpoint: "Create_${branch}_${projectName}"
        - call: gitCreateBranch
          in:
            url: ${apiUrl}

  performCleanupOperations:
    - checkpoint: "Clean_Up_${branch}_${projectName}"
    - call: gitDeleteBranch

  gitDeleteBranch:
    - task: git
      in:
        action: deleteBranch
        accessToken: ${githubToken}
        org: ${organization}
        repo: ${projectName}
        branch: ${branch}

  gitCloneBranch:
    - task: git
      in:
        action: clone
        workingDir: ${projectName}
        auth:
          basic:
            token: ${githubToken}
        baseBranch: ${branch}
        out: "response"
    - if: "${response.ok}"
      then:
        - set:
            filePath: "${workDir}/${projectName}"
      else:
        - log: "Error occurred while cloning necessary branch ...."

  gitCreateBranch:
    - task: git
      in:
        action: createBranch
        workingDir: ${projectName}
        auth:
          basic:
            token: ${githubToken}
        baseBranch: "main"
        newBranch: ${branch}
        pushBranch: true
        out: "response"
    - if: "${response.ok}"
      then:
        - set:
            filePath: "${workDir}/${projectName}"

      else:
        - log: "Error occurred while creating necessary branch ...."