flows:
  replayMessages:
    - form: replaySource
      values:
        executedBy: "${currentUser.username}"
        organization: ${organization}
        processId: ${txId}
    - checkpoint: "Processing Request ..."

    - expr: ${replaySource.messageIds.stream().flatMap(str -> str.split(",").stream()).toList()}
      out: messageIdentifiers
    - set:
        request:
          sourceUri: "${replaySource.sourceUrl}"
          sinkUri: "${replaySource.sinkUrl}"
          messageIds: ${messageIdentifiers}
        requestString: ${resource.prettyPrintJson(request)}

    - script: groovy
      body: |
        println("Request Object will be ${request}")

    - if: ${replaySource.environment == "prod"}
      then:
        - log: "Hawkeye Concord | Production is not yet ready ..."
      else:
        - log: "Hawkeye Concord | Invoking based on localhost ..."
        - log: "Hawkeye Concord | Reprocess Request Body: ${requestString}"

        - task: http
          in:
            method: POST
            url: "http://localhost:8080/api/v1/kafka/reprocess"
            body: "${requestString}"
            request: json
            response: json
            out: response
        - if: ${response.success}
          then:
            - log: "Response received: ${response.content}"